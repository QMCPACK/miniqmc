#include "Drivers/check_determinant.h"

template<>
double CheckDeterminantHelpers<DDT::KOKKOS>::runThreads(int np,
							      PrimeNumberSet<uint32_t>& myPrimes,
							      ParticleSet& ions,
							      int& nsteps,
							      int& nsubsteps)
{
  auto main_function = KOKKOS_LAMBDA (int thread_id, double& accumulated_error)
  {
    printf(" thread_id = %d\n",thread_id);
    CheckDeterminantHelpers<DDT::KOKKOS>
    ::thread_main(thread_id, myPrimes, ions, nsteps, nsubsteps, accumulated_error);
  };
  double accumulated_error = 0.0;

#if defined(KOKKOS_ENABLE_OPENMP) && !defined(KOKKOS_ENABLE_CUDA)
  // The kokkos check_determinant was never threaded
  // could be with
  // Kokkos::OpenMP::thread_pool_size();
  int num_threads = 1; 
  int ncrews = 1;   
  int crewsize = std::max(1,num_threads/ncrews); 
  printf(" In partition master with %d threads, %d crews.  Crewsize = %d \n",num_threads,ncrews,crewsize);
  Kokkos::parallel_reduce(crewsize, main_function, accumulated_error);
  //Kokkos::OpenMP::partition_master(main_function,nmovers,crewsize);
#else
  main_function(0, accumulated_error );
#endif  
  return accumulated_error;
}

